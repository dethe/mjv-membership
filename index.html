<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Modern Jive Vancouver - Membership</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans|PT+Serif:400,400i,700,700i" />
	<link rel="stylesheet" href="css/awsm-2.1.0.css" />
    <link rel="stylesheet" href="css/forms.css" />
    <link rel="stylesheet" href="lib/awesomplete.css" />
	<link rel="stylesheet" href="css/app.css" />
    <style>
        .hidden {
            /* Add animation later */
            display: none;
            position: absolute;
            left: -100000rem;
        }
    </style>
</head>
<body>
    <header>
	    <h1>Modern Jive Vancouver - Membership</h1>
    </header>
    <main>
        <article>
            <section>
                <form>
                    <p>
                        <input type="search" id="membersearch" autofocus />
                    </p>
                </form>
            </section>
            <aside>
                <button type="button" id="add-member" class="bg-orange">âž• Add Member</button>
            </aside>
            <section>
                <form>
                    <input type="hidden" id="id-display" />
                    <input type="hidden" id="id-edit" />
                    <p>
                        <label>First:</label>
                        <output id="first-display"></output>
                        <input type="text" id="first-edit" placeholder="Tyro" class="hidden" />
                    </p>
                    <p>
                        <label>Last:</label>
                        <output id="last-display"></output>
                        <input type="text" id="last-edit" placeholder="Dancer" class="hidden" />
                    </p>
                    <p>
                        <label>Email:</label>
                        <output id="email-display"></output>
                        <input type="email" id="email-edit" placeholder="tyro@vancouvermodernjive.com" class="hidden" />
                    </p>
                    <p>
                        <button type="button" id="edit-display" class="hidden bg-teal">Edit Member</button>
                        <button type="button" id="save-edit" class="hidden bg-aqua">Save Member</button>
                    </p>
                </form>
            </section>
        </article>
    </main>
    <script src="lib/awesomplete.min.js"></script>
    <script src="lib/stretchy.js"></script>
    <script src="js/members.js"></script>
	<script src="js/app.js"></script>
    <script>
    var search = document.getElementById('membersearch');
    var addbutton = document.getElementById('add-member');
    function Mode(fields, buttonfields, modename){
        this.fields = fields;
        this.buttonfields = buttonfields;
        this.uifields = fields.concat(buttonfields);
        this.modename = modename;
        this.init();
    }
    Mode.prototype = {
        init: function(){
            this.uifields.forEach(field => this[field] = document.getElementById(field + '-' + this.modename));
        },
        populate: function(member){
            this.fields.forEach(field => this[field].value = member[field]);
            this.buttonfields.forEach(field => this[field].classList.remove('hidden'));
        },
        values: function(){
            var vals = {};
            this.fields.forEach(field => vals[field] = this[field].value);
            return vals;
        },
        clear: function(){
            this.fields.forEach(field => this[field].value = '');
            this.buttonfields.forEach(field => this[field].classList.add('hidden'));
        },
        hide: function(){
            this.uifields.forEach(field => this[field].classList.add('hidden'));
        },
        show: function(){
            this.uifields.forEach(field => this[field].classList.remove('hidden'));
        }
    };
    var display = new Mode(['id', 'first', 'last', 'email'], ['edit'], 'display');
    var edit = new Mode(['id', 'first', 'last', 'email'], ['save'], 'edit');
    function memberById(id){
        for (var i = 0; i < members.length; i++){
            if (id === members[i].id){
                return members[i];
            }
        }
    }
    new Awesomplete(
        search,
        {
            list: members,
            autoFirst: true,
            data: function(member, key){
                return {label: member.first + ' ' + member.last, value: member.id}
            }
        }
    );
    /*
    When we've selected someone from the search, set to display mode and populate it
    */
    search.addEventListener('awesomplete-selectcomplete', function(event){
        var member = memberById(search.value);
        search.value = '';
        edit.hide();
        display.populate(member);
        display.show();
    });
    /*
    When starting a new search, clear both views and reset to display

    TODO: disable search if we're editing? Then we also need a cancel button.
    */
    search.addEventListener('awesomplete-open', function(event){
        display.clear();
    });
    addbutton.addEventListener('click', function(event){
        edit.clear();
        display.hide();
        edit.show();
        search.value = '';
        edit.first.focus();
        Stretchy.resizeAll();
    });
    display.edit.addEventListener('click', function(event){
        console.log('clicked display-edit');
        event.stopPropagation();
        edit.populate(display.values());
        display.hide();
        edit.show();
        edit.first.select();
        edit.first.focus();
        Stretchy.resizeAll();
    });
    edit.save.addEventListener('click', function(event){
        console.log('clicked edit-save');
        event.stopPropagation();
        display.populate(edit.values());
        // PERSIST CHANGES!
        // Make Undo-able
        edit.hide();
        display.show();
        search.focus();
    });
    </script>
</body>
</html>
